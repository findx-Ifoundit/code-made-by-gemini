<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .frequency-canvas {
            background-color: #1f2937; /* Dark gray background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* rounded-xl */
        }
        .container {
            max-width: 90%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">
    <div class="container mx-auto p-6 bg-white shadow-2xl rounded-2xl w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ»å‘¨æ³¢æ•°ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
        <p class="text-gray-600 mb-6 text-center">
            ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®å…±æœ‰ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§å¿…ãšã€Œã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®å…±æœ‰ã€ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚
        </p>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDè¡¨ç¤ºã‚¨ãƒªã‚¢ (Firebaseç”¨) -->
        <div id="auth-status" class="text-sm text-center mb-4 p-2 bg-blue-100 rounded-lg">
            èªè¨¼ä¸­...
        </div>

        <div class="flex flex-col items-center space-y-4">
            <!-- åˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
            <button id="startButton" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-105 disabled:opacity-50">
                ğŸš€ ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå…±æœ‰ï¼†åˆ†æé–‹å§‹
            </button>
            <button id="stopButton" class="px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300 transform hover:scale-105 disabled:opacity-50" disabled>
                â¹ï¸ åˆ†æåœæ­¢
            </button>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="message" class="text-orange-500 font-medium h-6"></div>

            <!-- ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒªã‚¢ -->
            <canvas id="frequencyCanvas" width="800" height="300" class="frequency-canvas w-full"></canvas>
        </div>

        <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (Firebase) -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            setLogLevel('Debug');

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®è¨­å®šï¼ˆCanvasç’°å¢ƒã‹ã‚‰æä¾›ã•ã‚Œã‚‹ã‚‚ã®ã‚’å„ªå…ˆï¼‰
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'audio-analyzer-app-default';
            let firebaseConfig = null;
            try {
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
                firebaseConfig = null;
            }
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            let db, auth, userId = 'loading';

            // FirebaseåˆæœŸåŒ–
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯
                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                };

                // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
                onAuthStateChanged(auth, (user) => {
                    const authStatusDiv = document.getElementById('auth-status');
                    if (user) {
                        userId = user.uid;
                        authStatusDiv.innerHTML = `âœ… èªè¨¼å®Œäº† | ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <code class="bg-blue-200 p-1 rounded">${userId}</code>`;
                        
                        // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’Firestoreã«ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                        const userRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'profile');
                        setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true }).catch(e => console.error("Firestore write error:", e));

                    } else {
                        userId = 'unauthenticated_' + crypto.randomUUID();
                        authStatusDiv.textContent = `âš ï¸ èªè¨¼ã‚¨ãƒ©ãƒ¼: åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’è©¦è¡Œä¸­...`;
                    }
                });

                authenticate();
            } else {
                console.error("Firebase config is missing. Running without persistent storage.");
                document.getElementById('auth-status').textContent = 'âš ï¸ FirebaseãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                userId = 'local_' + crypto.randomUUID();
            }

            // --- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            const canvas = document.getElementById('frequencyCanvas');
            const ctx = canvas.getContext('2d');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const messageDiv = document.getElementById('message');

            let audioContext = null;
            let analyser = null;
            let mediaStream = null;
            let animationId = null;

            // å‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’æç”»ã™ã‚‹é–¢æ•°
            function draw() {
                if (!analyser) return;

                animationId = requestAnimationFrame(draw);

                // å‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’æº–å‚™
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                // Canvasã‚’ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
                const barWidth = (canvas.width / bufferLength) * 2.5; // å°‘ã—é–“éš”ã‚’é–‹ã‘ã‚‹ãŸã‚ã«èª¿æ•´
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] * 1.5; // é«˜ã•ã‚’èª¿æ•´ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹

                    // å‘¨æ³¢æ•°ã«å¿œã˜ãŸã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ©ãƒ¼ã‚’è¨­å®š (é’ -> ç·‘ -> é»„ -> èµ¤)
                    let hue = i / bufferLength * 360; // 0 (Low) to 360 (High)
                    ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;

                    // ãƒãƒ¼ã‚’æç”» (ä¸‹ã‹ã‚‰ä¸Šã¸)
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 1; // ãƒãƒ¼ã¨ãƒãƒ¼ã®é–“ã«1pxã®ã‚¹ãƒšãƒ¼ã‚¹
                }
            }

            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å–å¾—ã¨åˆ†æé–‹å§‹
            async function startAnalysis() {
                if (audioContext && audioContext.state === 'running') {
                    messageDiv.textContent = 'åˆ†æã¯ã™ã§ã«å®Ÿè¡Œä¸­ã§ã™ã€‚';
                    return;
                }

                messageDiv.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã€Œã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å…±æœ‰ã€ã‚’é¸æŠã—ã¦ãã ã•ã„...';
                startButton.disabled = true;
                stopButton.disabled = true;

                try {
                    // getDisplayMedia() ã‚’ä½¿ç”¨ã—ã¦ã€ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å«ã‚€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å–å¾—
                    // audio: true, video: true (ç”»é¢é¸æŠã®ãŸã‚ã®è¨­å®š)
                    mediaStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true, // ç”»é¢é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚
                        audio: {
                            sampleRate: 44100, // é«˜å“è³ªãªã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                        }
                    });

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å«ã‚ãšã«å…±æœ‰ã—ãŸå ´åˆã®ãƒã‚§ãƒƒã‚¯
                    if (!mediaStream.getAudioTracks().length) {
                        messageDiv.textContent = 'âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãŒå…±æœ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚';
                        stopAnalysis();
                        return;
                    }

                    messageDiv.textContent = 'âœ… ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’å–å¾—ã—ã¾ã—ãŸã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æä¸­...';

                    // AudioContextã®åˆæœŸåŒ–
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // AnalyserNodeã®ä½œæˆ
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048; // FFTã‚µã‚¤ã‚º (å‘¨æ³¢æ•°åˆ†è§£èƒ½ã«å½±éŸ¿)
                    analyser.smoothingTimeConstant = 0.7; // æ»‘ã‚‰ã‹ã•ã®èª¿æ•´ (0:ç”Ÿãƒ‡ãƒ¼ã‚¿, 1:æœ€å¤§å¹³æ»‘åŒ–)

                    // MediaStreamSourceãƒãƒ¼ãƒ‰ã®ä½œæˆ
                    const source = audioContext.createMediaStreamSource(mediaStream);

                    // ãƒãƒ¼ãƒ‰ã®æ¥ç¶š: ã‚½ãƒ¼ã‚¹ -> ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ -> æœ€çµ‚çš„ãªå‡ºåŠ›(ä»Šå›ã¯æ¥ç¶šã—ãªã„)
                    source.connect(analyser);
                    // analyser.connect(audioContext.destination); // ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã¸ã®å‡ºåŠ›ã¯ä¸è¦

                    // æç”»ãƒ«ãƒ¼ãƒ—ã®é–‹å§‹
                    draw();

                    stopButton.disabled = false;

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…±æœ‰ã‚’åœæ­¢ã—ãŸéš›ã®å‡¦ç†
                    mediaStream.getVideoTracks()[0].onended = () => {
                        stopAnalysis();
                        messageDiv.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚';
                    };

                } catch (err) {
                    console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        messageDiv.textContent = 'ğŸš« ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚';
                    } else {
                        messageDiv.textContent = 'âŒ ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    }
                    stopAnalysis(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åœæ­¢å‡¦ç†ã‚’å‘¼ã¶
                }
                
                // åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå¾Œã€é–‹å§‹ãƒœã‚¿ãƒ³ã‚’å†ã³æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«ã€try/catchã®å¾Œã«è¨­å®š
                startButton.disabled = false;
            }

            // åˆ†æã®åœæ­¢ã¨ãƒªã‚½ãƒ¼ã‚¹ã®è§£æ”¾
            function stopAnalysis() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                if (audioContext) {
                    audioContext.close().catch(e => console.error("AudioContext close error:", e));
                    audioContext = null;
                    analyser = null;
                }
                
                // Canvasã‚’ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                messageDiv.textContent = 'åˆ†æã‚’åœæ­¢ã—ã¾ã—ãŸã€‚';
                startButton.disabled = false;
                stopButton.disabled = true;
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            startButton.addEventListener('click', startAnalysis);
            stopButton.addEventListener('click', stopAnalysis);

            // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«Canvasã‚’ãƒªã‚µã‚¤ã‚ºã™ã‚‹å‡¦ç†
            function resizeCanvas() {
                const container = document.getElementById('frequencyCanvas').parentElement;
                const width = container.clientWidth;
                canvas.width = width;
                canvas.height = width * 0.375; // 800x300ã«è¿‘ã„ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
            }

            // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã¨ãƒªã‚µã‚¤ã‚ºæ™‚ã«Canvasã‚µã‚¤ã‚ºã‚’è¨­å®š
            window.onload = () => {
                resizeCanvas();
            };
            window.addEventListener('resize', resizeCanvas);

        </script>
    </div>
</body>
</html>
