<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11月11月11月11月11秒ジャスト！！！</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap');
        
        :root {
            --adachi-orange: #ff6600;
            --adachi-light: #ffaa00;
            --adachi-dark: #1a0a00;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--adachi-dark);
            color: #fff;
            overflow-x: hidden;
            transition: background-color 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }

        body.just-moment {
            background-color: var(--adachi-orange) !important;
        }

        .true-text {
            color: #fff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8), 0 0 30px var(--adachi-light);
            transform: scale(1.05);
        }

        .false-text {
            color: var(--adachi-orange);
            opacity: 0.2;
            filter: grayscale(1);
        }

        .glitch-active {
            animation: intense-glitch 0.1s steps(2) infinite;
        }

        @keyframes intense-glitch {
            0% { transform: translate(2px, -2px); }
            50% { transform: translate(-2px, 2px); }
            100% { transform: translate(0); }
        }

        .item-container {
            transition: all 0.2s ease;
            background: rgba(255, 102, 0, 0.03);
            border: 1px solid rgba(255, 102, 0, 0.1);
        }

        .item-container.is-true {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.5);
        }

        .countdown-display {
            font-variant-numeric: tabular-nums;
            color: var(--adachi-orange);
            text-shadow: 0 0 20px rgba(255, 102, 0, 0.3);
        }

        .gacha-box {
            background: rgba(255, 102, 0, 0.05);
            border: 2px solid rgba(255, 102, 0, 0.2);
            box-shadow: inset 0 0 20px rgba(255, 102, 0, 0.1);
        }

        .loading-pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 py-12">

    <!-- ヘッダー -->
    <div class="mb-10 text-center">
        <p class="text-[10px] uppercase tracking-[0.5em] mb-3 text-orange-500/50 font-black">Adachi Rei Protocol</p>
        <h1 class="text-orange-400 text-sm italic font-bold">11月11月11月11月11秒ジャスト！！！</h1>
    </div>

    <!-- 判定グリッド -->
    <div id="status-display" class="flex flex-wrap justify-center gap-4 md:gap-8 mb-16">
        <!-- JS Managed -->
    </div>

    <!-- カウントダウン & 時計 -->
    <div class="w-full max-w-4xl px-4 mb-16">
        <div class="relative p-10 rounded-[3rem] overflow-hidden text-center border border-orange-500/10 bg-black/40 backdrop-blur-md shadow-2xl">
            <h2 id="countdown-label" class="text-[10px] mb-6 text-orange-500/40 tracking-[0.8em] uppercase font-black">Next Synchronization</h2>
            <div id="countdown" class="countdown-display text-5xl md:text-[7rem] font-mono font-black tracking-tighter leading-none mb-6">00:00:00:00</div>
            <div id="current-time" class="text-xl font-mono text-orange-500/50 italic mb-4">0000.00.00 00:00:00</div>
            <div class="text-[10px] font-mono text-orange-500/30 border-t border-orange-500/5 pt-6 flex justify-between">
                <span>LOGIC: Month(11) x 4 & Sec(11) x 1</span>
                <span id="current-ms">MS // 000</span>
            </div>
        </div>
    </div>

    <!-- 足立ガチャセクション -->
    <div class="w-full max-w-2xl px-4">
        <div class="gacha-box p-8 rounded-[2rem] relative overflow-hidden group">
            <div class="flex justify-between items-center mb-6">
                <span class="text-[10px] font-black uppercase tracking-[0.3em] text-orange-500/60">Adachi Gacha (Fixed 5m interval)</span>
                <button id="gacha-refresh" class="text-xs bg-orange-500/20 hover:bg-orange-500/40 px-3 py-1 rounded-full text-orange-400 font-bold transition-all">
                    ROLL AGAIN
                </button>
            </div>
            
            <div id="gacha-content" class="min-h-[100px] flex flex-col justify-center">
                <p id="gacha-text" class="text-lg md:text-xl font-bold leading-relaxed mb-4 text-orange-100 cursor-pointer hover:text-orange-400 transition-colors">
                    同期中...
                </p>
                <a id="gacha-link" href="#" target="_blank" class="text-[10px] font-mono text-orange-500/40 hover:text-orange-400 break-all">
                    URL: sync required
                </a>
            </div>

            <div id="gacha-timer" class="mt-6 h-1 bg-orange-500/10 rounded-full overflow-hidden">
                <div id="gacha-progress" class="h-full bg-orange-500 transition-all duration-500 ease-linear" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-[8px] font-mono text-orange-500/30 text-right uppercase">
                Next Sync at: <span id="next-sync-time">--:--:00</span>
            </div>
        </div>
    </div>

    <script>
        const statusDisplay = document.getElementById('status-display');
        const countdownDisplay = document.getElementById('countdown');
        const currentTimeDisplay = document.getElementById('current-time');
        const currentMsDisplay = document.getElementById('current-ms');
        const countdownLabel = document.getElementById('countdown-label');
        
        const gachaText = document.getElementById('gacha-text');
        const gachaLink = document.getElementById('gacha-link');
        const gachaRefresh = document.getElementById('gacha-refresh');
        const gachaProgress = document.getElementById('gacha-progress');
        const nextSyncTimeDisplay = document.getElementById('next-sync-time');

        let lastStateStr = "";
        let confettiInterval = null;
        let lastSyncedMinute = -1;

        async function rollGacha() {
            gachaText.classList.add('loading-pulse');
            gachaText.textContent = "データを同期しています...";
            
            try {
                const response = await fetch('https://adachi.2237yh.net/api/posts/random');
                const data = await response.json();
                
                gachaText.textContent = data.text || "（テキストなし）";
                gachaLink.textContent = `URL: ${data.url}`;
                gachaLink.href = data.url;
                gachaText.onclick = () => window.open(data.url, '_blank');
                
                gachaText.classList.remove('loading-pulse');
            } catch (error) {
                gachaText.textContent = "同期エラー。再度お試しください。";
                gachaText.classList.remove('loading-pulse');
            }
        }

        gachaRefresh.onclick = rollGacha;

        function fireConfetti() {
            const opt = { particleCount: 10, spread: 55, colors: ['#ff6600', '#ffffff', '#ffaa00'], zIndex: 100 };
            confetti({ ...opt, angle: 60, origin: { x: 0, y: 1 } });
            confetti({ ...opt, angle: 120, origin: { x: 1, y: 1 } });
        }

        function update() {
            const now = new Date();
            const ms = now.getMilliseconds();
            const month = now.getMonth() + 1;
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            currentMsDisplay.textContent = `MS // ${String(ms).padStart(3, '0')}`;
            currentTimeDisplay.textContent = 
                `${now.getFullYear()}.${String(month).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ` +
                `${String(now.getHours()).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // ロジック修正：月と秒を独立して判定するように変更
            const isNovember = month === 11;
            const is11Seconds = seconds === 11;
            
            const criteria = [
                { label: "11月", val: isNovember },
                { label: "11月", val: isNovember },
                { label: "11月", val: isNovember },
                { label: "11月", val: isNovember },
                { label: "11秒", val: is11Seconds } // 11月条件を外して秒単体で光るように修正
            ];

            const currentStateStr = criteria.map(c => c.val).join(',');
            const isAllTrue = criteria.every(c => c.val);

            if (currentStateStr !== lastStateStr) {
                renderStatus(criteria, isAllTrue);
                lastStateStr = currentStateStr;

                if (isAllTrue) {
                    document.body.classList.add('just-moment');
                    fireConfetti();
                    if (!confettiInterval) confettiInterval = setInterval(fireConfetti, 150);
                } else {
                    document.body.classList.remove('just-moment');
                    if (confettiInterval) { clearInterval(confettiInterval); confettiInterval = null; }
                }
            }

            if (minutes % 5 === 0 && lastSyncedMinute !== minutes) {
                lastSyncedMinute = minutes;
                rollGacha();
            }

            const currentTotalSeconds = (minutes % 5) * 60 + seconds;
            const totalSecondsInWindow = 5 * 60;
            const progress = (currentTotalSeconds / totalSecondsInWindow) * 100;
            gachaProgress.style.width = `${progress}%`;

            const nextSyncMin = (Math.floor(minutes / 5) + 1) * 5;
            const displayMin = nextSyncMin >= 60 ? 0 : nextSyncMin;
            const nextSyncHour = nextSyncMin >= 60 ? (now.getHours() + 1) % 24 : now.getHours();
            nextSyncTimeDisplay.textContent = `${String(nextSyncHour).padStart(2, '0')}:${String(displayMin).padStart(2, '0')}:00`;

            updateCountdown(now, isNovember);
            requestAnimationFrame(update);
        }

        function renderStatus(criteria, allTrue) {
            statusDisplay.innerHTML = '';
            criteria.forEach(item => {
                const div = document.createElement('div');
                div.className = `item-container p-6 md:p-10 rounded-3xl min-w-[140px] md:min-w-[180px] flex flex-col items-center shadow-xl ${item.val ? 'is-true true-text' : 'false-text'}`;
                if (item.val && allTrue) div.classList.add('glitch-active');
                div.innerHTML = `
                    <div class="text-[10px] uppercase tracking-[0.3em] font-black mb-2">${item.label}</div>
                    <div class="text-4xl md:text-6xl font-black uppercase tracking-tighter">${item.val ? 'true' : 'false'}</div>
                `;
                statusDisplay.appendChild(div);
            });
        }

        function updateCountdown(now, isNovember) {
            let target;
            if (!isNovember) {
                let targetYear = now.getFullYear();
                if (now.getMonth() >= 11) targetYear++;
                target = new Date(targetYear, 10, 1, 0, 0, 11);
                countdownLabel.textContent = "Next 11-Month Window";
            } else {
                target = new Date(now.getTime());
                target.setMilliseconds(0);
                if (now.getSeconds() >= 11) {
                    target.setSeconds(11);
                    target.setMinutes(target.getMinutes() + 1);
                } else {
                    target.setSeconds(11);
                }
                countdownLabel.textContent = "Next 11-Seconds Sync";
            }

            const diff = target - now;
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            if (isNovember) {
                const displayMs = Math.floor((diff % 1000) / 10);
                countdownDisplay.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}.${String(displayMs).padStart(2, '0')}`;
            } else {
                countdownDisplay.textContent = `${String(d).padStart(3, '0')}:${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
        }

        rollGacha();
        requestAnimationFrame(update);
    </script>
</body>
</html>
